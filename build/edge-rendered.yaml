apiVersion: v1
kind: Namespace
metadata:
  labels:
    app.kubernetes.io/part-of: agentforge
    profile: edge
  name: agentforge-edge
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: agentforge
  namespace: agentforge-edge
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: agentforge-basic
  namespace: agentforge-edge
rules:
- apiGroups:
  - ""
  resources:
  - pods
  - configmaps
  - secrets
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: agentforge-binding
  namespace: agentforge-edge
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: agentforge-basic
subjects:
- kind: ServiceAccount
  name: agentforge
  namespace: agentforge-edge
---
apiVersion: v1
data:
  AIRGAPPED: "1"
  CRITIC_HEALER_ENABLED: "1"
  DISPATCH_MODE: nats
  EDGE_MODE: "1"
  ENV: edge
  EXTERNAL_TOOLS: "0"
  JETSTREAM_PATH: /lib/nats
  LOCAL_ARTIFACTS_DIR: /app/var/artifacts
  MEMORY_MESH_MODE: dist
  MISSION: edge
  NATS_FETCH_BATCH: "4"
  NATS_FETCH_WAIT: "8.0"
  NATS_URL: nats://nats:4222
  SECURITY_HARDENED: "1"
  SWARM_DB_URL: sqlite:////app/var/swarm.db
  VECTOR_DB_URL: sqlite:////app/var/vector.db
  VECTOR_ENABLED: "1"
  VECTOR_SYNC: "0"
kind: ConfigMap
metadata:
  name: agentforge-config
  namespace: agentforge-edge
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: nats
  name: nats
  namespace: agentforge-edge
spec:
  ports:
  - name: client
    port: 4222
    targetPort: 4222
  - name: monitoring
    port: 8222
    targetPort: 8222
  selector:
    app: nats
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: syncdaemon
  name: syncdaemon
  namespace: agentforge-edge
spec:
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  selector:
    app: syncdaemon
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nats-pv
spec:
  accessModes:
  - ReadWriteOnce
  capacity:
    storage: 10Gi
  hostPath:
    path: /lib/nats
    type: DirectoryOrCreate
  persistentVolumeReclaimPolicy: Retain
  storageClassName: ""
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nats-pvc
  namespace: agentforge-edge
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: ""
  volumeName: nats-pv
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: syncdaemon
  name: syncdaemon
  namespace: agentforge-edge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: syncdaemon
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/syncdaemon: runtime/default
      labels:
        app: syncdaemon
    spec:
      containers:
      - envFrom:
        - configMapRef:
            name: agentforge-config
        image: agentforge/syncdaemon:dev
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /livez
            port: http
          initialDelaySeconds: 10
          periodSeconds: 20
        name: syncdaemon
        ports:
        - containerPort: 8080
          name: http
        readinessProbe:
          httpGet:
            path: /healthz
            port: http
          initialDelaySeconds: 5
          periodSeconds: 10
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsGroup: 1000
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
        - mountPath: /tmp
          name: tmp
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: agentforge
      volumes:
      - emptyDir: {}
        name: tmp
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nats
  namespace: agentforge-edge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nats
  serviceName: nats
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/nats: runtime/default
      labels:
        app: nats
    spec:
      containers:
      - args:
        - -js
        - -m
        - "8222"
        - -sd
        - /lib/nats/jetstream
        image: 'registry.local/nats:2.10-alpine@sha256: 1111111111111111111111111111111111111111111111111111111111111111'
        name: nats
        ports:
        - containerPort: 4222
        - containerPort: 8222
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsGroup: 1000
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
        - mountPath: /lib/nats
          name: nats-data
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: agentforge
      terminationGracePeriodSeconds: 15
      volumes:
      - name: nats-data
        persistentVolumeClaim:
          claimName: nats-pvc
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: nats
  namespace: agentforge-edge
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: nats
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: agentforge-edge-services
  namespace: agentforge-edge
spec:
  endpoints:
  - interval: 30s
    port: monitoring
  namespaceSelector:
    matchNames:
    - agentforge-edge
  selector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - nats
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: syncdaemon
  namespace: agentforge-edge
spec:
  endpoints:
  - interval: 30s
    port: http
  namespaceSelector:
    matchNames:
    - agentforge-edge
  selector:
    matchLabels:
      app: syncdaemon
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: agentforge-edge
spec:
  egress:
  - ports:
    - port: 53
      protocol: UDP
    - port: 53
      protocol: TCP
    to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
  podSelector: {}
  policyTypes:
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal-egress
  namespace: agentforge-edge
spec:
  egress:
  - to:
    - podSelector: {}
  podSelector: {}
  policyTypes:
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prom-grafana-ingress
  namespace: agentforge-edge
spec:
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: grafana
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
  podSelector: {}
  policyTypes:
  - Ingress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: agentforge-edge
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
