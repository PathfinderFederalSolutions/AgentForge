FROM node:20-bullseye AS build
WORKDIR /app

# Speed up installs by caching deps
COPY ui/tactical-dashboard/package.json ui/tactical-dashboard/pnpm-lock.yaml* ./
RUN corepack enable && corepack prepare pnpm@latest --activate
RUN pnpm install --frozen-lockfile

# Copy source and build
COPY ui/tactical-dashboard/ ./
RUN pnpm build

# ---- Runtime image
FROM nginx:stable-alpine
# Copy static assets
COPY --from=build /app/dist/ /usr/share/nginx/html
# Copy nginx config (from Step 21)
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

# ---------- build stage ----------
FROM node:20-bullseye AS build
WORKDIR /app

# copy only the package files first to leverage caching
COPY ui/tactical-dashboard/package.json ui/tactical-dashboard/pnpm-lock.yaml* ./ 
RUN corepack enable && corepack prepare pnpm@latest --activate
RUN pnpm install --frozen-lockfile

# now copy the rest of the frontend sources
COPY ui/tactical-dashboard/ ./
RUN pnpm build   # must output to /app/dist

# ---------- nginx stage ----------
FROM nginx:stable-alpine
# copy the vite build
COPY --from=build /app/dist/ /usr/share/nginx/html
# copy nginx.conf that lives next to this Dockerfile at repo root
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
