name: Un-Staller Test Harness

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      integration_tests:
        description: 'Enable integration tests'
        required: false
        default: 'false'
        type: boolean

jobs:
  unstaller-tests:
    name: Un-Staller Test Harness
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Global safety net
    
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.13"]
      fail-fast: false  # Continue testing other versions even if one fails
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify Un-Staller setup
      run: |
        echo "ðŸ” Verifying Un-Staller Test Harness setup..."
        ls -la scripts/run_unstaller_tests.sh
        ls -la scripts/run_unstaller_tests.py
        ls -la pytest.ini
        ls -la tests/conftest.py
        python -c "import pytest, pytest_timeout, pytest_asyncio; print('âœ… Required pytest plugins available')"
        
    - name: Run Un-Staller Test Harness (Mocked)
      env:
        INTEGRATION: "0"
        TEST_TIMEOUT: "60"  # Shorter timeout in CI
        GLOBAL_TIMEOUT: "1800"  # 30 minutes
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸš€ Running Un-Staller Test Harness with mocked dependencies..."
        bash scripts/run_unstaller_tests.sh --timeout 60
        
    - name: Run Un-Staller Test Harness (Integration)
      if: ${{ github.event.inputs.integration_tests == 'true' || github.event_name == 'workflow_dispatch' }}
      env:
        INTEGRATION: "1"
        TEST_TIMEOUT: "90"
        GLOBAL_TIMEOUT: "2400"  # 40 minutes for integration
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸš€ Running Un-Staller Test Harness with integration tests..."
        # Start NATS server for integration tests
        docker run -d --name nats-ci -p 4222:4222 -p 8222:8222 nats:2.10-alpine -js
        sleep 5  # Wait for NATS to be ready
        
        # Run tests with live services
        bash scripts/run_unstaller_tests.sh --integration --timeout 90
        
        # Cleanup
        docker stop nats-ci || true
        docker rm nats-ci || true
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-python-${{ matrix.python-version }}
        path: |
          test_results_*.json
          test_summary_*.txt
        retention-days: 30
        
    - name: Generate test report summary
      if: always()
      run: |
        echo "## ðŸŽ¯ Un-Staller Test Results (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
        
        # Find the latest test results file
        LATEST_RESULTS=$(find . -name "test_results_*.json" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2- || echo "")
        
        if [[ -n "$LATEST_RESULTS" ]] && [[ -f "$LATEST_RESULTS" ]]; then
          echo "ðŸ“Š **Results file:** \`$(basename "$LATEST_RESULTS")\`" >> $GITHUB_STEP_SUMMARY
          
          # Extract summary stats
          if command -v jq >/dev/null 2>&1; then
            TOTAL=$(jq -r '.summary.total' "$LATEST_RESULTS" 2>/dev/null || echo "0")
            PASSED=$(jq -r '.summary.passed' "$LATEST_RESULTS" 2>/dev/null || echo "0")
            FAILED=$(jq -r '.summary.failed' "$LATEST_RESULTS" 2>/dev/null || echo "0")
            TIMEOUTS=$(jq -r '.summary.timeouts' "$LATEST_RESULTS" 2>/dev/null || echo "0")
            DURATION=$(jq -r '.summary.duration | floor' "$LATEST_RESULTS" 2>/dev/null || echo "0")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â° Timeouts | $TIMEOUTS |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${DURATION}s |" >> $GITHUB_STEP_SUMMARY
            
            if [[ "$FAILED" != "0" ]] || [[ "$TIMEOUTS" != "0" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **Test failures detected.** Check the detailed results file for more information." >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        else
          echo "âš ï¸ No test results file found." >> $GITHUB_STEP_SUMMARY
        fi

  # Aggregate results from all Python versions
  aggregate-results:
    name: Aggregate Test Results
    runs-on: ubuntu-latest
    needs: unstaller-tests
    if: always()
    
    steps:
    - name: Download all test results
      uses: actions/download-artifact@v3
      with:
        path: test-results
        
    - name: Generate aggregate summary
      run: |
        echo "# ðŸŽ¯ Un-Staller Test Harness - Aggregate Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        total_files=0
        total_passed=0
        total_failed=0
        total_timeouts=0
        
        for results_dir in test-results/*/; do
          if [[ -d "$results_dir" ]]; then
            python_version=$(basename "$results_dir" | sed 's/test-results-python-//')
            echo "## Python $python_version" >> $GITHUB_STEP_SUMMARY
            
            latest_result=$(find "$results_dir" -name "test_results_*.json" | head -1)
            if [[ -n "$latest_result" ]] && [[ -f "$latest_result" ]]; then
              if command -v jq >/dev/null 2>&1; then
                passed=$(jq -r '.summary.passed' "$latest_result" 2>/dev/null || echo "0")
                failed=$(jq -r '.summary.failed' "$latest_result" 2>/dev/null || echo "0")
                timeouts=$(jq -r '.summary.timeouts' "$latest_result" 2>/dev/null || echo "0")
                total=$(jq -r '.summary.total' "$latest_result" 2>/dev/null || echo "0")
                
                echo "- âœ… Passed: $passed" >> $GITHUB_STEP_SUMMARY
                echo "- âŒ Failed: $failed" >> $GITHUB_STEP_SUMMARY  
                echo "- â° Timeouts: $timeouts" >> $GITHUB_STEP_SUMMARY
                echo "- ðŸ“Š Total: $total" >> $GITHUB_STEP_SUMMARY
                
                total_files=$((total_files + total))
                total_passed=$((total_passed + passed))
                total_failed=$((total_failed + failed))
                total_timeouts=$((total_timeouts + timeouts))
              fi
            else
              echo "- âš ï¸ No results found" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "## ðŸ“ˆ Overall Summary" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ Total test files: $total_files" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Total passed: $total_passed" >> $GITHUB_STEP_SUMMARY
        echo "- âŒ Total failed: $total_failed" >> $GITHUB_STEP_SUMMARY
        echo "- â° Total timeouts: $total_timeouts" >> $GITHUB_STEP_SUMMARY
        
        if [[ $total_failed -eq 0 ]] && [[ $total_timeouts -eq 0 ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **All tests passed across all Python versions!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¥ **Some tests failed or timed out. Please review the detailed results.**" >> $GITHUB_STEP_SUMMARY
        fi
